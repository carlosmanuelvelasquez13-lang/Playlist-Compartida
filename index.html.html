<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://fav.farm/üéµ" />
    <title>Playlist Privada Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --tema: #34495e; --fondo: #f4f7f6; --card-bg: #ffffff; --texto: #2c3e50;
            --spotify: #1DB954; --yt: #FF0000;
        }

        body { 
            font-family: 'Poppins', sans-serif; background: var(--fondo); 
            display: flex; justify-content: center; align-items: flex-start; padding: 20px 15px; margin: 0; 
            min-height: 100vh; color: var(--texto); -webkit-font-smoothing: antialiased;
            transition: background 0.3s ease;
        }

        .container { 
            background: rgba(255, 255, 255, 0.98);
            width: 100%; max-width: 1000px; padding: 30px; 
            border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; 
            position: relative;
        }

        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ESTAD√çSTICAS Y CONECTADOS */
        .stats-bar {
            display: flex; justify-content: center; gap: 20px; margin-bottom: 20px;
            font-size: 0.85rem; font-weight: 600; color: #7f8c8d;
        }
        .online-now {
            background: #e8f8f5; color: #27ae60; padding: 5px 15px; border-radius: 20px;
            display: flex; align-items: center; gap: 5px; margin: 10px auto; width: fit-content;
        }
        .online-dot { width: 8px; height: 8px; background: #2ecc71; border-radius: 50%; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .users-list { 
            display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 5px;
        }
        .user-tag {
            background: #fff; border: 1px solid #ddd; padding: 2px 10px; border-radius: 12px;
            font-size: 0.7rem; color: var(--tema);
        }

        /* NUEVOS ESTILOS: HISTORIAL DE COLABORADORES */
        .history-panel {
            background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 20px;
            border: 1px solid #eee; text-align: left;
        }
        .history-title { font-size: 0.75rem; font-weight: 800; color: var(--tema); text-transform: uppercase; margin-bottom: 10px; display: block; }
        .history-list { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
        .history-item { 
            min-width: 140px; background: #f9f9f9; padding: 8px; border-radius: 10px; font-size: 0.7rem;
            border-left: 3px solid var(--tema);
        }
        .history-item b { display: block; color: var(--texto); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .history-item span { color: #888; }

        /* PALETA DE 12 COLORES MEJORADA */
        #color-palette {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px;
        }
        .color-dot {
            height: 45px; border-radius: 12px; cursor: pointer; border: 2px solid transparent; transition: 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .color-dot:hover { transform: scale(1.1); border-color: rgba(0,0,0,0.2); }

        .alphabet-section { text-align: left; margin-top: 30px; }
        .alphabet-header { 
            font-size: 1.5rem; font-weight: 800; color: var(--tema); 
            border-bottom: 2px solid #eee; margin-bottom: 15px; padding-left: 10px;
        }
        .grid-section {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 15px;
        }
        
        .song-card { 
            display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 16px; 
            background: #fff; border: 1px solid #f0f0f0; transition: 0.2s;
            position: relative;
        }
        .song-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
        .song-card img.thumb { width: 60px; height: 60px; border-radius: 12px; object-fit: cover; }

        .compact-actions { 
            display: flex; align-items: center; gap: 12px; margin-top: 8px; 
            padding-top: 8px; border-top: 1px solid #f5f5f5;
        }
        .mini-social-icon { width: 20px; height: 20px; opacity: 0.6; transition: 0.3s; filter: grayscale(1); }
        .mini-social-icon:hover { opacity: 1; filter: grayscale(0); transform: scale(1.2); }

        .action-btn-mini { background: none; border: none; cursor: pointer; font-size: 16px; opacity: 0.5; transition: 0.2s; padding: 0; display: flex; align-items: center; }
        .action-btn-mini:hover { opacity: 1; color: var(--tema); }

        .pienso { border-left: 5px solid #fdd835; } 
        .gusta { border-left: 5px solid #66bb6a; }
        .deprime { border-left: 5px solid #42a5f5; } 
        .favorita { border-left: 5px solid #ff5252; }

        .btn-tema { width: 100%; padding: 12px; border-radius: 12px; border: none; background: var(--tema); color: white; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .input-formal { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; font-size: 1rem; }
        
        .playlist-chip { background: #eee; padding: 8px 18px; border-radius: 20px; font-size: 0.85em; cursor: pointer; font-weight: 600; white-space: nowrap; border: none; transition: 0.3s; }
        .playlist-chip.active { background: var(--tema); color: white; }
        
        .icon-btn { position: fixed; bottom: 25px; cursor: pointer; background: white; width: 55px; height: 55px; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 1000; border: none; font-size: 22px; }

        .card-note {
            background: #fff9c4; padding: 15px; border-radius: 15px; margin-bottom: 15px;
            text-align: left; position: relative; border: 1px solid #fbc02d;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.05);
        }
        .card-note b { color: #f57f17; display: block; margin-bottom: 5px; }
        .multi-select-area {
            background: #f9f9f9; padding: 10px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 10px;
            max-height: 100px; overflow-y: auto; text-align: left;
        }
        .multi-option { display: block; font-size: 0.8rem; margin-bottom: 3px; cursor: pointer; }

        @media (max-width: 600px) { 
            .grid-section { grid-template-columns: 1fr; }
            .container { padding: 20px 15px; border-radius: 20px; }
            .song-card { padding: 10px; gap: 10px; }
            .song-card img.thumb { width: 50px; height: 50px; }
            #color-palette { grid-template-columns: repeat(3, 1fr); }
            h1 { font-size: 2.5rem !important; }
            .icon-btn { width: 50px; height: 50px; bottom: 15px; }
            #config-btn { right: 75px !important; }
            #add-btn-toggle { right: 15px !important; }
            #manager-btn-toggle { left: 15px !important; }
        }
    </style>
</head>
<body>

    <button id="config-btn" class="icon-btn" style="right: 85px; color: #555;" onclick="toggleConfigView()">‚öôÔ∏è</button>
    <button id="add-btn-toggle" class="icon-btn" style="right: 25px; background: var(--tema); color: white;" onclick="toggleAddForm()">+</button>
    <button id="manager-btn-toggle" class="icon-btn" style="left: 25px; color: var(--tema);" onclick="showView('manager-view')">üìÇ</button>

    <div class="container">
        <div id="login-screen" class="view active">
            <h1 style="font-family:'Dancing Script'; color:var(--tema); font-size:3.5rem; margin:0;">Playlist Privada</h1>
            <div style="max-width:350px; margin:20px auto;">
                <input type="text" id="user-nick" class="input-formal" placeholder="Tu Apodo">
                <input type="text" id="room-name" class="input-formal" placeholder="Nombre de la Sala">
                <input type="password" id="room-pass" class="input-formal" placeholder="Contrase√±a">
                <button class="btn-tema" onclick="accessRoom()">Entrar</button>
            </div>
        </div>

        <div id="main-content" class="view">
            <h1 id="display-room-name" style="font-family:'Dancing Script'; font-size:2.5rem; color:var(--tema); margin-bottom:5px;">SALA</h1>
            
            <div class="stats-bar">
                <span>üéµ <span id="total-songs-count">0</span> canciones</span>
                <span>üìÇ <span id="total-lists-count">1</span> listas</span>
            </div>

            <div class="online-now">
                <div class="online-dot"></div>
                <span id="online-count">1</span> en l√≠nea
            </div>
            <div id="users-connected" class="users-list"></div>

            <button class="btn-tema" style="width:auto; padding:8px 20px; font-size:0.8em; border-radius:30px; margin-bottom: 20px; margin-top:10px;" onclick="playRandomMix()">‚ñ∂Ô∏è MIX RANDOM</button>

            <div class="history-panel">
                <span class="history-title">üïí √öltimas adiciones</span>
                <div id="collab-history" class="history-list">
                    <p style="font-size:0.7rem; color:#999;">A√∫n no hay actividad...</p>
                </div>
            </div>

            <div id="playlists-chips" style="display:flex; gap:8px; justify-content:center; margin-bottom:15px; overflow-x:auto; padding: 5px;"></div>

            <input type="text" id="search-input" class="input-formal" placeholder="üîç Buscar por nombre o artista..." oninput="renderSongs()">
            
            <div id="add-form" style="display:none; background:#fafafa; padding:20px; border-radius:20px; margin-bottom:25px; border:1px solid #eee; text-align: left;">
                <label id="form-label" style="font-weight: 800; font-size: 0.7rem; color: var(--tema);">A√ëADIR CANCI√ìN</label>
                <input type="text" id="song-name" class="input-formal" placeholder="Nombre de la Canci√≥n - Artista">
                <input type="text" id="song-url" class="input-formal" placeholder="Enlace de YouTube">
                <input type="text" id="song-message" class="input-formal" placeholder="Mensaje especial o dedicatoria (opcional)">
                
                <div style="margin-bottom: 10px;">
                    <label style="font-size: 0.7rem; font-weight: bold;">Participar en listas:</label>
                    <div id="multi-list-selector" class="multi-select-area">
                        </div>
                </div>

                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <select id="song-mood" class="input-formal" style="margin-bottom:0;">
                        <option value="pienso">Pienso en ti üí≠</option>
                        <option value="gusta" selected>Me gusta üëç</option>
                        <option value="deprime">Me deprime üíô</option>
                        <option value="favorita">Mi Favorita ‚ù§Ô∏è</option>
                    </select>
                </div>

                <button class="btn-tema" id="save-btn" onclick="saveSong()">Guardar</button>
                <button class="btn-tema" style="background:#eee; color:#444; margin-top:5px; display:none;" onclick="cancelEdit()" id="cancel-btn">Cancelar</button>
            </div>

            <div id="playlist"></div>
        </div>

        <div id="manager-view" class="view">
            <h2 style="font-family:'Dancing Script'; color:var(--tema); font-size:2rem;">Mis Listas</h2>
            <button class="btn-tema" onclick="createNewPlaylist()">+ Nueva Lista</button>
            <div id="manager-list-container" style="margin:20px 0; display: flex; flex-direction: column; gap: 10px;"></div>
            <button class="btn-tema" style="background:#eee; color:#444;" onclick="showView('main-content')">Volver</button>
        </div>

        <div id="config-view" class="view">
            <h2 style="font-family:'Dancing Script'; color:var(--tema); font-size:2rem;">Ajustes y Notas</h2>
            
            <div style="background: white; padding: 15px; border-radius: 20px; border: 1px solid #eee; margin-bottom: 20px;">
                <h3 style="font-size: 1rem; margin-top: 0;">Dejar una Carta / Nota</h3>
                <input type="text" id="note-author" class="input-formal" placeholder="Nombre del Autor">
                <textarea id="note-text" class="input-formal" style="height: 80px;" placeholder="Escribe tu carta aqu√≠..."></textarea>
                <select id="note-song-select" class="input-formal">
                    <option value="">Seleccionar una canci√≥n para la nota</option>
                </select>
                <button class="btn-tema" onclick="saveNote()">Publicar Nota</button>
                <div id="notes-container" style="margin-top: 20px;"></div>
            </div>

            <div style="text-align: left; margin-bottom: 20px;">
                <label style="font-size: 0.8rem; font-weight: 700;">Nombre de la Sala:</label>
                <input type="text" id="edit-room-name-input" class="input-formal" placeholder="Nuevo nombre">
                <button class="btn-tema" style="padding: 8px;" onclick="renameRoom()">Actualizar Nombre</button>
            </div>

            <p style="font-size: 0.8rem; color: #666; font-weight: bold;">Personalizar Colores:</p>
            <div id="color-palette">
                <div class="color-dot" style="background:#34495e;" onclick="updateRoomTheme('#34495e', '#f4f7f6')"></div>
                <div class="color-dot" style="background:#e74c3c;" onclick="updateRoomTheme('#e74c3c', '#fdf2f2')"></div>
                <div class="color-dot" style="background:#2ecc71;" onclick="updateRoomTheme('#2ecc71', '#f2fdf5')"></div>
                <div class="color-dot" style="background:#f1c40f;" onclick="updateRoomTheme('#f1c40f', '#fefdf2')"></div>
                <div class="color-dot" style="background:#9b59b6;" onclick="updateRoomTheme('#9b59b6', '#f9f2fd')"></div>
                <div class="color-dot" style="background:#3498db;" onclick="updateRoomTheme('#3498db', '#f2f9fd')"></div>
                <div class="color-dot" style="background:#e67e22;" onclick="updateRoomTheme('#e67e22', '#fdf7f2')"></div>
                <div class="color-dot" style="background:#1abc9c;" onclick="updateRoomTheme('#1abc9c', '#f2fdfb')"></div>
                <div class="color-dot" style="background:#ff79c6;" onclick="updateRoomTheme('#ff79c6', '#fff0f9')"></div>
                <div class="color-dot" style="background:#2c3e50;" onclick="updateRoomTheme('#2c3e50', '#ebedee')"></div>
                <div class="color-dot" style="background:#6c5ce7;" onclick="updateRoomTheme('#6c5ce7', '#f3f2ff')"></div>
                <div class="color-dot" style="background:#d63031;" onclick="updateRoomTheme('#d63031', '#fff2f2')"></div>
            </div>
            <button class="btn-tema" style="background:#eee; color:#444; margin-top:30px;" onclick="showView('main-content')">Cerrar</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCMP_tpzNCNhakeG3wMd_P1YTJ-McmLL5k",
            authDomain: "nuestra-playlist-415c8.firebaseapp.com",
            databaseURL: "https://nuestra-playlist-415c8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "nuestra-playlist-415c8",
            storageBucket: "nuestra-playlist-415c8.firebasestorage.app",
            messagingSenderId: "446803210132",
            appId: "1:446803210132:web:1347277b5bb8d3ec5f2981"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentRoom = "", myNick = "", allSongs = [], allLists = [], editingId = null, currentFilterList = "general";

        window.onload = () => {
            const savedNick = localStorage.getItem('playlist_user_nick');
            if(savedNick) document.getElementById('user-nick').value = savedNick;
        };

        function accessRoom() {
            const nick = document.getElementById('user-nick').value.trim();
            const name = document.getElementById('room-name').value.trim().toLowerCase();
            const pass = document.getElementById('room-pass').value.trim();
            if(!nick || !name || !pass) return;
            
            myNick = nick;
            localStorage.setItem('playlist_user_nick', nick);

            db.ref('salas/' + name).once('value', s => {
                const d = s.val();
                if(d && d.password === pass) {
                    if(d.theme) applyTheme(d.theme, d.bg);
                    startSession(name);
                }
                else if(!d) {
                    if(confirm("¬øCrear sala nueva?")) {
                        db.ref('salas/' + name).set({ password: pass, theme: '#34495e', bg: '#f4f7f6', displayName: name.toUpperCase() });
                        startSession(name);
                    }
                } else alert("Contrase√±a incorrecta");
            });
        }

        function startSession(name) {
            currentRoom = name;
            showView('main-content');
            
            const userRef = db.ref(`salas/${currentRoom}/presence/${myNick}`);
            userRef.set(true);
            userRef.onDisconnect().remove();

            db.ref(`salas/${currentRoom}/presence`).on('value', snap => {
                const users = snap.val() ? Object.keys(snap.val()) : [];
                document.getElementById('online-count').innerText = users.length;
                document.getElementById('users-connected').innerHTML = users.map(u => `<span class="user-tag">${u}</span>`).join('');
            });

            db.ref(`salas/${currentRoom}`).on('value', snap => {
                const d = snap.val();
                if(d) {
                    if(d.theme) applyTheme(d.theme, d.bg);
                    const nameToShow = d.displayName || currentRoom.toUpperCase();
                    document.getElementById('display-room-name').innerText = nameToShow;
                    document.getElementById('edit-room-name-input').value = nameToShow;
                }
            });

            db.ref(`canciones/${currentRoom}`).on('value', snap => {
                const d = snap.val();
                allSongs = d ? Object.keys(d).map(k => ({ id: k, ...d[k] })) : [];
                document.getElementById('total-songs-count').innerText = allSongs.length;
                renderSongs();
                renderCollabHistory(); // Renderizar historial cada vez que cambian canciones
                updateNoteSongSelect();
            });

            db.ref(`listas/${currentRoom}`).on('value', snap => {
                const d = snap.val();
                allLists = d ? Object.keys(d).map(k => ({ id: k, ...d[k] })) : [];
                document.getElementById('total-lists-count').innerText = allLists.length + 1;
                renderLists();
                renderChips();
                updateMultiListSelector();
            });

            db.ref(`notas/${currentRoom}`).on('value', snap => {
                const d = snap.val();
                const notes = d ? Object.keys(d).map(k => ({ id: k, ...d[k] })) : [];
                renderNotes(notes);
            });
        }

        function renderCollabHistory() {
            const container = document.getElementById('collab-history');
            if(allSongs.length === 0) {
                container.innerHTML = `<p style="font-size:0.7rem; color:#999;">A√∫n no hay actividad...</p>`;
                return;
            }
            // Obtenemos las √∫ltimas 8 a√±adidas (asumiendo que Firebase las devuelve o las ordenamos por ID/timestamp si existiera)
            // Como no hay timestamp expl√≠cito, usamos el orden de inserci√≥n de Firebase (reversa)
            const recent = [...allSongs].reverse().slice(0, 8);
            container.innerHTML = recent.map(s => `
                <div class="history-item">
                    <b>${s.name}</b>
                    <span>por ${s.addedBy || 'An√≥nimo'}</span>
                </div>
            `).join('');
        }

        function renameRoom() {
            const newName = document.getElementById('edit-room-name-input').value.trim();
            if(newName) {
                db.ref(`salas/${currentRoom}`).update({ displayName: newName });
                alert("Nombre de sala actualizado");
            }
        }

        function applyTheme(tema, fondo) {
            document.documentElement.style.setProperty('--tema', tema);
            document.documentElement.style.setProperty('--fondo', fondo);
        }

        function updateRoomTheme(tema, fondo) {
            applyTheme(tema, fondo);
            db.ref(`salas/${currentRoom}`).update({ theme: tema, bg: fondo });
        }

        function toggleConfigView() {
            showView('config-view');
        }

        function updateMultiListSelector() {
            const container = document.getElementById('multi-list-selector');
            let html = `<label class="multi-option"><input type="checkbox" value="general" checked> Lista General</label>`;
            allLists.forEach(l => {
                html += `<label class="multi-option"><input type="checkbox" value="${l.id}"> ${l.name}</label>`;
            });
            container.innerHTML = html;
        }

        function updateNoteSongSelect() {
            const select = document.getElementById('note-song-select');
            let options = '<option value="">Seleccionar una canci√≥n para la nota</option>';
            allSongs.forEach(s => {
                options += `<option value="${s.id}">${s.name}</option>`;
            });
            select.innerHTML = options;
        }

        function createNewPlaylist() {
            const name = prompt("Nombre de la nueva lista:");
            if(name) db.ref(`listas/${currentRoom}`).push({ name: name, createdBy: myNick });
        }

        function deleteList(id) {
            if(confirm("¬øEliminar lista?")) {
                db.ref(`listas/${currentRoom}/${id}`).remove();
                allSongs.forEach(s => {
                    if(s.listIds && s.listIds.includes(id)) {
                        const newLists = s.listIds.filter(lid => lid !== id);
                        if(newLists.length === 0) newLists.push('general');
                        db.ref(`canciones/${currentRoom}/${s.id}`).update({ listIds: newLists });
                    }
                });
            }
        }

        function renderLists() {
            const container = document.getElementById('manager-list-container');
            container.innerHTML = `<div style="background:white; padding:15px; border-radius:15px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee;">
                    <span><b>Lista General</b></span>
                </div>` + allLists.map(l => `
                <div style="background:white; padding:15px; border-radius:15px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee;">
                    <span><b>${l.name}</b></span>
                    <button onclick="deleteList('${l.id}')" style="background:none; border:none; color:red; cursor:pointer;">‚úï</button>
                </div>
            `).join('');
        }

        function renderChips() {
            const container = document.getElementById('playlists-chips');
            let html = `<button class="playlist-chip ${currentFilterList === 'general' ? 'active' : ''}" onclick="filterByList('general')">General</button>`;
            allLists.forEach(l => {
                html += `<button class="playlist-chip ${currentFilterList === l.id ? 'active' : ''}" onclick="filterByList('${l.id}')">${l.name}</button>`;
            });
            container.innerHTML = html;
        }

        function filterByList(listId) {
            currentFilterList = listId;
            renderChips();
            renderSongs();
        }

        function renderSongs() {
            const container = document.getElementById('playlist');
            const search = document.getElementById('search-input').value.toLowerCase();
            
            let filtered = allSongs.filter(s => {
                const matchesSearch = s.name.toLowerCase().includes(search);
                const listIds = s.listIds || ['general'];
                const matchesList = listIds.includes(currentFilterList);
                return matchesSearch && matchesList;
            });
            
            filtered.sort((a, b) => a.name.localeCompare(b.name));
            const groups = {};
            filtered.forEach(s => {
                let char = s.name.charAt(0).toUpperCase();
                if (!/[A-Z]/.test(char)) char = "#";
                if (!groups[char]) groups[char] = [];
                groups[char].push(s);
            });
            const sortedChars = Object.keys(groups).sort((a, b) => a === "#" ? -1 : b === "#" ? 1 : a.localeCompare(b));
            
            if(filtered.length === 0) {
                container.innerHTML = "<p style='opacity:0.5; margin-top:30px;'>No hay canciones en esta lista.</p>";
                return;
            }

            container.innerHTML = sortedChars.map(char => `
                <div class="alphabet-section">
                    <div class="alphabet-header">${char}</div>
                    <div class="grid-section">
                        ${groups[char].map(s => `
                            <div class="song-card ${s.mood}">
                                <img src="${s.img}" class="thumb">
                                <div style="flex:1; min-width:0; text-align:left;">
                                    <b style="font-size:0.85em; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${s.name}</b>
                                    <small style="font-size:0.65em; color:#999; display:block;">Agregado por: <b>${s.addedBy || 'An√≥nimo'}</b></small>
                                    ${s.message ? `<p style="font-size:0.7rem; font-style:italic; margin: 4px 0; color:var(--tema);">" ${s.message} "</p>` : ''}
                                    <div class="compact-actions">
                                        <a href="${s.url}" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png" class="mini-social-icon"></a>
                                        <a href="https://open.spotify.com/search/${encodeURIComponent(s.name)}" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/174/174872.png" class="mini-social-icon"></a>
                                        <div style="width:1px; height:12px; background:#ddd;"></div>
                                        <button class="action-btn-mini" onclick="editSong('${s.id}')">‚úèÔ∏è</button>
                                        <button class="action-btn-mini" onclick="eliminarCancion('${s.id}')" style="color:#ff7675;">‚úï</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function saveSong() {
            const n = document.getElementById('song-name').value.trim();
            const u = document.getElementById('song-url').value.trim();
            const msg = document.getElementById('song-message').value.trim();
            const m = document.getElementById('song-mood').value;
            
            const selectedLists = Array.from(document.querySelectorAll('#multi-list-selector input:checked')).map(cb => cb.value);
            if(selectedLists.length === 0) selectedLists.push('general');

            if(!n || !u) return;
            let idV = u.includes('v=') ? u.split('v=')[1].substring(0,11) : u.split('/').pop().split('?')[0];
            
            // Si estamos editando, mantenemos el autor original a menos que queramos que cambie
            const existingSong = editingId ? allSongs.find(x => x.id === editingId) : null;
            const data = { 
                name: n, url: u, mood: m, message: msg, 
                addedBy: existingSong ? (existingSong.addedBy || myNick) : myNick, 
                img: `https://img.youtube.com/vi/${idV}/mqdefault.jpg`, 
                listIds: selectedLists 
            };
            
            if(editingId) db.ref(`canciones/${currentRoom}/${editingId}`).update(data);
            else db.ref(`canciones/${currentRoom}`).push(data);
            
            cancelEdit();
            toggleAddForm();
        }

        function editSong(id) {
            const s = allSongs.find(x => x.id === id);
            editingId = id;
            document.getElementById('song-name').value = s.name;
            document.getElementById('song-url').value = s.url;
            document.getElementById('song-message').value = s.message || '';
            document.getElementById('song-mood').value = s.mood;
            
            const checks = document.querySelectorAll('#multi-list-selector input');
            checks.forEach(cb => {
                cb.checked = s.listIds ? s.listIds.includes(cb.value) : (cb.value === 'general');
            });

            document.getElementById('form-label').innerText = "EDITAR CANCI√ìN";
            document.getElementById('cancel-btn').style.display = "block";
            document.getElementById('add-form').style.display = "block";
            window.scrollTo(0,0);
        }

        function cancelEdit() {
            editingId = null;
            document.getElementById('song-name').value = '';
            document.getElementById('song-url').value = '';
            document.getElementById('song-message').value = '';
            document.getElementById('form-label').innerText = "A√ëADIR CANCI√ìN";
            document.getElementById('cancel-btn').style.display = "none";
            updateMultiListSelector();
        }

        function saveNote() {
            const author = document.getElementById('note-author').value.trim();
            const text = document.getElementById('note-text').value.trim();
            const songId = document.getElementById('note-song-select').value;
            if(!author || !text) return alert("Escribe tu nombre y el mensaje");
            
            const song = allSongs.find(s => s.id === songId) || null;
            db.ref(`notas/${currentRoom}`).push({
                author, text, song, date: new Date().toLocaleString()
            });
            document.getElementById('note-author').value = '';
            document.getElementById('note-text').value = '';
        }

        function renderNotes(notes) {
            const container = document.getElementById('notes-container');
            container.innerHTML = notes.reverse().map(n => `
                <div class="card-note">
                    <b>${n.author}</b>
                    <p style="margin:5px 0; font-size:0.9rem;">${n.text}</p>
                    ${n.song ? `
                        <div style="display:flex; align-items:center; gap:10px; background:rgba(255,255,255,0.5); padding:5px; border-radius:10px; border:1px solid #fbc02d;">
                            <img src="${n.song.img}" style="width:30px; height:30px; border-radius:5px;">
                            <small style="font-weight:bold; font-size:0.7rem;">üéµ ${n.song.name}</small>
                        </div>
                    ` : ''}
                    <small style="display:block; text-align:right; font-size:0.6rem; margin-top:5px; opacity:0.6;">${n.date}</small>
                    <button onclick="db.ref('notas/${currentRoom}/${n.id}').remove()" style="position:absolute; top:5px; right:5px; background:none; border:none; color:red; cursor:pointer;">‚úï</button>
                </div>
            `).join('');
        }

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            const isMain = (viewId === 'main-content');
            document.getElementById('add-btn-toggle').style.display = isMain ? 'flex' : 'none';
            document.getElementById('manager-btn-toggle').style.display = isMain ? 'flex' : 'none';
            document.getElementById('config-btn').style.display = isMain ? 'flex' : 'none';
        }

        function toggleAddForm() {
            const f = document.getElementById('add-form');
            f.style.display = f.style.display === 'none' ? 'block' : 'none';
        }

        function eliminarCancion(id) {
            if(confirm("¬øQuitar canci√≥n?")) db.ref(`canciones/${currentRoom}/${id}`).remove();
        }

        function playRandomMix() {
            let list = allSongs.filter(s => (s.listIds || ['general']).includes(currentFilterList));
            if(list.length === 0) return alert("No hay canciones en esta lista");
            const ids = list.sort(() => 0.5 - Math.random()).slice(0, 50).map(x => 
                x.url.includes('v=') ? x.url.split('v=')[1].substring(0,11) : x.url.split('/').pop().split('?')[0]
            );
            window.open(`https://www.youtube.com/watch_videos?video_ids=${ids.join(',')}`, '_blank');
        }
    </script>
</body>
</html>
