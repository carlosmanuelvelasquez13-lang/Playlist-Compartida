<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://fav.farm/üéµ" />
    <title>Playlist Privada Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --tema: #34495e; --fondo: #f4f7f6; --card-bg: #ffffff; --texto: #2c3e50;
            --spotify: #1DB954; --yt: #FF0000;
        }

        body { 
            font-family: 'Poppins', sans-serif; background: var(--fondo); 
            display: flex; justify-content: center; align-items: flex-start; padding: 20px 15px; margin: 0; 
            min-height: 100vh; color: var(--texto); -webkit-font-smoothing: antialiased;
            transition: background 0.3s ease;
        }

        .container { 
            background: rgba(255, 255, 255, 0.98);
            width: 100%; max-width: 1000px; padding: 30px; 
            border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); text-align: center; 
            position: relative;
        }

        .view { display: none; animation: fadeIn 0.3s ease; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Estilos de la paleta de colores */
        #color-palette {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;
        }
        .color-dot {
            height: 40px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: 0.2s;
        }
        .color-dot:hover { transform: scale(1.05); border-color: rgba(0,0,0,0.1); }

        .alphabet-section { text-align: left; margin-top: 30px; }
        .alphabet-header { 
            font-size: 1.5rem; font-weight: 800; color: var(--tema); 
            border-bottom: 2px solid #eee; margin-bottom: 15px; padding-left: 10px;
        }
        .grid-section {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 15px;
        }
        
        .song-card { 
            display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 16px; 
            background: #fff; border: 1px solid #f0f0f0; transition: 0.2s;
        }
        .song-card:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.06); }
        .song-card img.thumb { width: 55px; height: 55px; border-radius: 12px; object-fit: cover; }

        .compact-actions { 
            display: flex; align-items: center; gap: 10px; margin-top: 6px; 
            padding-top: 6px; border-top: 1px solid #f5f5f5;
        }
        .mini-social-icon { width: 18px; height: 18px; opacity: 0.6; transition: 0.3s; filter: grayscale(1); }
        .mini-social-icon:hover { opacity: 1; filter: grayscale(0); transform: scale(1.2); }

        .action-btn-mini { background: none; border: none; cursor: pointer; font-size: 14px; opacity: 0.5; transition: 0.2s; padding: 0; display: flex; align-items: center; }
        .action-btn-mini:hover { opacity: 1; color: var(--tema); }

        .pienso { border-left: 5px solid #fdd835; } 
        .gusta { border-left: 5px solid #66bb6a; }
        .deprime { border-left: 5px solid #42a5f5; } 
        .favorita { border-left: 5px solid #ff5252; }

        .btn-tema { width: 100%; padding: 12px; border-radius: 12px; border: none; background: var(--tema); color: white; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .input-formal { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 12px; border: 1px solid #eee; box-sizing: border-box; font-family: inherit; }
        
        .playlist-chip { background: #eee; padding: 6px 15px; border-radius: 20px; font-size: 0.75em; cursor: pointer; font-weight: 600; white-space: nowrap; border: none; transition: 0.3s; }
        .playlist-chip.active { background: var(--tema); color: white; }
        
        .icon-btn { position: fixed; bottom: 25px; cursor: pointer; background: white; width: 50px; height: 50px; border-radius: 50%; display: none; align-items: center; justify-content: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1); z-index: 1000; border: none; }

        @media (max-width: 600px) { .grid-section { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <button id="config-btn" class="icon-btn" style="right: 85px; color: #888;" onclick="toggleConfigView()">üé®</button>
    <button id="add-btn-toggle" class="icon-btn" style="right: 25px; background: var(--tema); color: white;" onclick="toggleAddForm()">+</button>
    <button id="manager-btn-toggle" class="icon-btn" style="left: 25px; color: var(--tema);" onclick="showView('manager-view')">üìÇ</button>

    <div class="container">
        <div id="login-screen" class="view active">
            <h1 style="font-family:'Dancing Script'; color:var(--tema); font-size:3.5rem; margin:0;">Playlist Privada</h1>
            <div style="max-width:350px; margin:20px auto;">
                <input type="text" id="user-nick" class="input-formal" placeholder="Tu Apodo">
                <input type="text" id="room-name" class="input-formal" placeholder="Nombre de la Sala">
                <input type="password" id="room-pass" class="input-formal" placeholder="Contrase√±a">
                <button class="btn-tema" onclick="accessRoom()">Entrar</button>
            </div>
        </div>

        <div id="main-content" class="view">
            <h1 id="display-room-name" style="font-family:'Dancing Script'; font-size:2.5rem; color:var(--tema); margin:0;">SALA</h1>
            
            <button class="btn-tema" style="width:auto; padding:8px 20px; font-size:0.8em; border-radius:30px; margin-bottom: 20px; margin-top:10px;" onclick="playRandomMix()">‚ñ∂Ô∏è MIX RANDOM</button>

            <div id="playlists-chips" style="display:flex; gap:8px; justify-content:center; margin-bottom:15px; overflow-x:auto; padding: 5px;"></div>

            <input type="text" id="search-input" class="input-formal" placeholder="üîç Buscar por nombre o artista..." oninput="renderSongs()">
            
            <div id="add-form" style="display:none; background:#fafafa; padding:20px; border-radius:20px; margin-bottom:25px; border:1px solid #eee; text-align: left;">
                <label id="form-label" style="font-weight: 800; font-size: 0.7rem; color: var(--tema);">A√ëADIR CANCI√ìN</label>
                <input type="text" id="song-name" class="input-formal" placeholder="Nombre de la Canci√≥n - Artista">
                <input type="text" id="song-url" class="input-formal" placeholder="Enlace de YouTube">
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <select id="song-mood" class="input-formal" style="margin-bottom:0;">
                        <option value="pienso">Pienso en ti üí≠</option>
                        <option value="gusta" selected>Me gusta üëç</option>
                        <option value="deprime">Me deprime üíô</option>
                        <option value="favorita">Mi Favorita ‚ù§Ô∏è</option>
                    </select>
                    <select id="song-list-select" class="input-formal" style="margin-bottom:0;">
                        <option value="general">Lista General</option>
                    </select>
                </div>

                <button class="btn-tema" id="save-btn" onclick="saveSong()">Guardar</button>
                <button class="btn-tema" style="background:#eee; color:#444; margin-top:5px; display:none;" onclick="cancelEdit()" id="cancel-btn">Cancelar</button>
            </div>

            <div id="playlist"></div>
        </div>

        <div id="manager-view" class="view">
            <h2 style="font-family:'Dancing Script'; color:var(--tema); font-size:2rem;">Mis Listas</h2>
            <button class="btn-tema" onclick="createNewPlaylist()">+ Nueva Lista</button>
            <div id="manager-list-container" style="margin:20px 0; display: flex; flex-direction: column; gap: 10px;"></div>
            <button class="btn-tema" style="background:#eee; color:#444;" onclick="showView('main-content')">Volver</button>
        </div>

        <div id="config-view" class="view">
            <h2 style="font-family:'Dancing Script'; color:var(--tema); font-size:2rem;">Personalizar Sala</h2>
            <p style="font-size: 0.8rem; color: #666;">Selecciona un color para la sala:</p>
            <div id="color-palette">
                <div class="color-dot" style="background:#34495e;" onclick="updateRoomTheme('#34495e', '#f4f7f6')"></div>
                <div class="color-dot" style="background:#e74c3c;" onclick="updateRoomTheme('#e74c3c', '#fdf2f2')"></div>
                <div class="color-dot" style="background:#2ecc71;" onclick="updateRoomTheme('#2ecc71', '#f2fdf5')"></div>
                <div class="color-dot" style="background:#f1c40f;" onclick="updateRoomTheme('#f1c40f', '#fefdf2')"></div>
                <div class="color-dot" style="background:#9b59b6;" onclick="updateRoomTheme('#9b59b6', '#f9f2fd')"></div>
                <div class="color-dot" style="background:#3498db;" onclick="updateRoomTheme('#3498db', '#f2f9fd')"></div>
                <div class="color-dot" style="background:#e67e22;" onclick="updateRoomTheme('#e67e22', '#fdf7f2')"></div>
                <div class="color-dot" style="background:#1abc9c;" onclick="updateRoomTheme('#1abc9c', '#f2fdfb')"></div>
                <div class="color-dot" style="background:#2c3e50;" onclick="updateRoomTheme('#2c3e50', '#ebedee')"></div>
            </div>
            <button class="btn-tema" style="background:#eee; color:#444; margin-top:30px;" onclick="showView('main-content')">Cerrar</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCMP_tpzNCNhakeG3wMd_P1YTJ-McmLL5k",
            authDomain: "nuestra-playlist-415c8.firebaseapp.com",
            databaseURL: "https://nuestra-playlist-415c8-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "nuestra-playlist-415c8",
            storageBucket: "nuestra-playlist-415c8.firebasestorage.app",
            messagingSenderId: "446803210132",
            appId: "1:446803210132:web:1347277b5bb8d3ec5f2981"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        let currentRoom = "", myNick = "", allSongs = [], allLists = [], editingId = null, currentFilterList = "";

        window.onload = () => {
            const savedNick = localStorage.getItem('playlist_user_nick');
            if(savedNick) document.getElementById('user-nick').value = savedNick;
        };

        function accessRoom() {
            const nick = document.getElementById('user-nick').value.trim();
            const name = document.getElementById('room-name').value.trim().toLowerCase();
            const pass = document.getElementById('room-pass').value.trim();
            if(!nick || !name || !pass) return;
            
            myNick = nick;
            localStorage.setItem('playlist_user_nick', nick);

            db.ref('salas/' + name).once('value', s => {
                const d = s.val();
                if(d && d.password === pass) {
                    if(d.theme) applyTheme(d.theme, d.bg);
                    startSession(name);
                }
                else if(!d) {
                    if(confirm("¬øCrear sala nueva?")) {
                        db.ref('salas/' + name).set({ password: pass, theme: '#34495e', bg: '#f4f7f6' });
                        startSession(name);
                    }
                } else alert("Contrase√±a incorrecta");
            });
        }

        function startSession(name) {
            currentRoom = name;
            document.getElementById('display-room-name').innerText = name.toUpperCase();
            showView('main-content');
            
            // Escuchar cambios de tema en tiempo real
            db.ref(`salas/${currentRoom}`).on('value', snap => {
                const d = snap.val();
                if(d && d.theme) applyTheme(d.theme, d.bg);
            });

            db.ref(`canciones/${currentRoom}`).on('value', snap => {
                const d = snap.val();
                allSongs = d ? Object.keys(d).map(k => ({ id: k, ...d[k] })) : [];
                renderSongs();
            });

            db.ref(`listas/${currentRoom}`).on('value', snap => {
                const d = snap.val();
                allLists = d ? Object.keys(d).map(k => ({ id: k, ...d[k] })) : [];
                if(!currentFilterList) currentFilterList = "general";
                renderLists();
                renderChips();
                updateListSelector();
            });
        }

        function applyTheme(tema, fondo) {
            document.documentElement.style.setProperty('--tema', tema);
            document.documentElement.style.setProperty('--fondo', fondo);
        }

        function updateRoomTheme(tema, fondo) {
            applyTheme(tema, fondo);
            db.ref(`salas/${currentRoom}`).update({ theme: tema, bg: fondo });
        }

        function toggleConfigView() {
            showView('config-view');
        }

        function updateListSelector() {
            const select = document.getElementById('song-list-select');
            let options = '<option value="general">Lista General</option>';
            allLists.forEach(l => {
                options += `<option value="${l.id}">${l.name}</option>`;
            });
            select.innerHTML = options;
        }

        function createNewPlaylist() {
            const name = prompt("Nombre de la nueva lista:");
            if(name) db.ref(`listas/${currentRoom}`).push({ name: name, createdBy: myNick });
        }

        function addSongToList(listId) {
            showView('main-content');
            if(document.getElementById('add-form').style.display === 'none') toggleAddForm();
            document.getElementById('song-list-select').value = listId;
            window.scrollTo(0,0);
        }

        function moveSongToList(songId) {
            let options = "0: Lista General\n";
            allLists.forEach((l, index) => { options += `${index + 1}: ${l.name}\n`; });
            const choice = prompt("Mover a:\n" + options);
            if (choice !== null) {
                let targetListId = "general";
                if (choice !== "0") {
                    const idx = parseInt(choice) - 1;
                    if (allLists[idx]) targetListId = allLists[idx].id;
                    else return alert("Opci√≥n no v√°lida");
                }
                db.ref(`canciones/${currentRoom}/${songId}`).update({ listId: targetListId });
            }
        }

        function deleteList(id) {
            if(confirm("¬øEliminar lista? Las canciones volver√°n a 'General'")) {
                db.ref(`listas/${currentRoom}/${id}`).remove();
                allSongs.forEach(s => {
                    if(s.listId === id) db.ref(`canciones/${currentRoom}/${s.id}`).update({ listId: 'general' });
                });
            }
        }

        function renderLists() {
            const container = document.getElementById('manager-list-container');
            container.innerHTML = `<div style="background:white; padding:15px; border-radius:15px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee;">
                    <span><b>Lista General</b></span>
                    <button onclick="addSongToList('general')" style="background:#4cd137; border:none; color:white; cursor:pointer; width:30px; height:30px; border-radius:50%; font-weight:bold;">+</button>
                </div>` + allLists.map(l => `
                <div style="background:white; padding:15px; border-radius:15px; display:flex; justify-content:space-between; align-items:center; border:1px solid #eee;">
                    <span><b>${l.name}</b></span>
                    <div style="display:flex; gap:10px;">
                        <button onclick="addSongToList('${l.id}')" style="background:#4cd137; border:none; color:white; cursor:pointer; width:30px; height:30px; border-radius:50%; font-weight:bold;">+</button>
                        <button onclick="deleteList('${l.id}')" style="background:none; border:none; color:red; cursor:pointer;">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        function renderChips() {
            const container = document.getElementById('playlists-chips');
            let html = `<button class="playlist-chip ${currentFilterList === 'general' ? 'active' : ''}" onclick="filterByList('general')">General</button>`;
            html += allLists.map(l => `
                <button class="playlist-chip ${currentFilterList === l.id ? 'active' : ''}" onclick="filterByList('${l.id}')">${l.name}</button>
            `).join('');
            container.innerHTML = html;
        }

        function filterByList(listId) {
            currentFilterList = listId;
            renderChips();
            renderSongs();
        }

        function renderSongs() {
            const container = document.getElementById('playlist');
            const search = document.getElementById('search-input').value.toLowerCase();
            let filtered = allSongs.filter(s => s.name.toLowerCase().includes(search));
            filtered = filtered.filter(s => (s.listId || 'general') === currentFilterList);
            
            filtered.sort((a, b) => a.name.localeCompare(b.name));
            const groups = {};
            filtered.forEach(s => {
                let char = s.name.charAt(0).toUpperCase();
                if (!/[A-Z]/.test(char)) char = "#";
                if (!groups[char]) groups[char] = [];
                groups[char].push(s);
            });
            const sortedChars = Object.keys(groups).sort((a, b) => a === "#" ? -1 : b === "#" ? 1 : a.localeCompare(b));
            
            if(filtered.length === 0) {
                container.innerHTML = "<p style='opacity:0.5; margin-top:30px;'>No hay canciones en esta lista.</p>";
                return;
            }

            container.innerHTML = sortedChars.map(char => `
                <div class="alphabet-section">
                    <div class="alphabet-header">${char}</div>
                    <div class="grid-section">
                        ${groups[char].map(s => `
                            <div class="song-card ${s.mood}">
                                <img src="${s.img}" class="thumb">
                                <div style="flex:1; min-width:0;">
                                    <b style="font-size:0.85em; display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${s.name}</b>
                                    <small style="font-size:0.6em; color:#999;">Agregada por: ${s.addedBy}</small>
                                    <div class="compact-actions">
                                        <a href="${s.url}" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png" class="mini-social-icon"></a>
                                        <a href="https://open.spotify.com/search/${encodeURIComponent(s.name)}" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/174/174872.png" class="mini-social-icon"></a>
                                        <div style="width:1px; height:10px; background:#eee;"></div>
                                        <button class="action-btn-mini" onclick="moveSongToList('${s.id}')" title="Mover">üìÇ</button>
                                        <button class="action-btn-mini" onclick="editSong('${s.id}')">‚úèÔ∏è</button>
                                        <button class="action-btn-mini" onclick="eliminarCancion('${s.id}')" style="color:#ff7675;">‚úï</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function saveSong() {
            const n = document.getElementById('song-name').value.trim();
            const u = document.getElementById('song-url').value.trim();
            const m = document.getElementById('song-mood').value;
            const lId = document.getElementById('song-list-select').value;
            if(!n || !u) return;
            let idV = u.includes('v=') ? u.split('v=')[1].substring(0,11) : u.split('/').pop().split('?')[0];
            const data = { name: n, url: u, mood: m, addedBy: myNick, img: `https://img.youtube.com/vi/${idV}/mqdefault.jpg`, listId: lId };
            if(editingId) db.ref(`canciones/${currentRoom}/${editingId}`).update(data);
            else db.ref(`canciones/${currentRoom}`).push(data);
            cancelEdit();
            toggleAddForm();
        }

        function editSong(id) {
            const s = allSongs.find(x => x.id === id);
            editingId = id;
            document.getElementById('song-name').value = s.name;
            document.getElementById('song-url').value = s.url;
            document.getElementById('song-mood').value = s.mood;
            document.getElementById('song-list-select').value = s.listId || 'general';
            document.getElementById('form-label').innerText = "EDITAR CANCI√ìN";
            document.getElementById('cancel-btn').style.display = "block";
            document.getElementById('add-form').style.display = "block";
            window.scrollTo(0,0);
        }

        function cancelEdit() {
            editingId = null;
            document.getElementById('song-name').value = '';
            document.getElementById('song-url').value = '';
            document.getElementById('form-label').innerText = "A√ëADIR CANCI√ìN";
            document.getElementById('cancel-btn').style.display = "none";
        }

        function showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
            const isMain = (viewId === 'main-content');
            document.getElementById('add-btn-toggle').style.display = isMain ? 'flex' : 'none';
            document.getElementById('manager-btn-toggle').style.display = isMain ? 'flex' : 'none';
            document.getElementById('config-btn').style.display = isMain ? 'flex' : 'none';
        }

        function toggleAddForm() {
            const f = document.getElementById('add-form');
            f.style.display = f.style.display === 'none' ? 'block' : 'none';
        }

        function eliminarCancion(id) {
            if(confirm("¬øQuitar canci√≥n?")) db.ref(`canciones/${currentRoom}/${id}`).remove();
        }

        function playRandomMix() {
            let list = allSongs.filter(s => (s.listId || 'general') === currentFilterList);
            if(list.length === 0) return alert("No hay canciones en esta lista");
            const ids = list.sort(() => 0.5 - Math.random()).slice(0, 50).map(x => 
                x.url.includes('v=') ? x.url.split('v=')[1].substring(0,11) : x.url.split('/').pop().split('?')[0]
            );
            window.open(`https://www.youtube.com/watch_videos?video_ids=${ids.join(',')}`, '_blank');
        }
    </script>
</body>
</html>
