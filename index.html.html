<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://fav.farm/üéµ" />
    <title>Playlist Privada</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --tema: #34495e; --fondo: #f4f7f6; --card-bg: #ffffff; --texto: #2c3e50;
        }

        body { 
            font-family: 'Poppins', sans-serif; background: var(--fondo); 
            display: flex; justify-content: center; padding: 15px; margin: 0; 
            transition: all 0.5s ease; color: var(--texto);
        }
        
        .container { 
            background: var(--card-bg); width: 100%; max-width: 400px; padding: 25px 20px; 
            border-radius: 20px; box-shadow: 0 5px 25px rgba(0,0,0,0.03); text-align: center; 
            position: relative; min-height: 85vh;
        }

        .room-title { font-family: 'Dancing Script', cursive; font-size: 1.8rem; color: var(--tema); margin: 0; }
        
        #total-count { font-size: 0.65em; letter-spacing: 2px; opacity: 0.5; font-weight: 600; margin-bottom: 15px; text-transform: uppercase; }

        /* BUSCADOR COMPACTO Y CENTRADO */
        .search-container { 
            display: flex; 
            justify-content: center; 
            margin-bottom: 20px; 
        }
        .search-box {
            position: relative;
            width: 85%; /* M√°s peque√±o para centrar visualmente */
        }
        .input-search { 
            width: 100%; 
            padding: 10px 15px 10px 35px; /* Espacio para la lupa */
            border-radius: 25px; 
            border: 1px solid #eee; 
            background: #fafafa; 
            font-family: 'Poppins'; 
            font-size: 0.75em; 
            outline: none; 
            transition: 0.3s;
            box-sizing: border-box;
        }
        .input-search:focus { border-color: var(--tema); background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        /* ICONO DE LUPA */
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.8em;
            opacity: 0.4;
            pointer-events: none;
        }

        .legend { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; font-size: 0.55em; font-weight: 600; opacity: 0.7; }
        .legend-item { display: flex; align-items: center; gap: 3px; }
        .dot-l { width: 8px; height: 8px; border-radius: 50%; }

        .input-formal { 
            width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 10px; 
            border: 1px solid #eee; box-sizing: border-box; font-family: 'Poppins'; font-size: 0.85em;
        }
        .btn-tema { 
            width: 100%; padding: 12px; border-radius: 10px; border: none; 
            background: var(--tema); color: white; font-weight: 600; cursor: pointer;
        }

        #add-form { display: none; margin-bottom: 20px; padding: 15px; background: #fafafa; border-radius: 12px; animation: fadeIn 0.3s; }

        .letter-divider {
            display: flex; align-items: center; font-size: 0.65em; color: var(--tema);
            opacity: 0.4; margin: 20px 0 8px; font-weight: 700;
        }
        .letter-divider::after { content: ""; flex: 1; height: 1px; background: var(--tema); margin-left: 10px; opacity: 0.1; }

        .song-card { 
            display: flex; align-items: center; padding: 8px 12px; border-radius: 10px; 
            margin-bottom: 6px; text-align: left; background: #fff; border: 1px solid #f5f5f5;
        }
        .song-card img { width: 35px; height: 35px; border-radius: 6px; margin-right: 12px; object-fit: cover; }
        .song-info b { font-size: 0.8em; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .pienso { border-right: 4px solid #fdd835; background: #fffde7; }
        .gusta { border-right: 4px solid #66bb6a; background: #e8f5e9; }
        .deprime { border-right: 4px solid #42a5f5; background: #e3f2fd; }
        .favorita { border-right: 4px solid #ff5252; background: #ffebee; }

        .icon-btn { 
            position: fixed; bottom: 20px; cursor: pointer; background: white; 
            width: 40px; height: 40px; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; box-shadow: 0 3px 10px rgba(0,0,0,0.1); 
            z-index: 1000; border: none; font-size: 1rem;
        }
        #add-btn-toggle { right: 20px; background: var(--tema); color: white; display: none; }
        #config-btn { right: 70px; display: none; color: #888; }
        #papiro-btn { left: 20px; display: none; color: #888; }

        .color-picker {
            display: none; position: fixed; bottom: 70px; right: 20px; 
            background: white; padding: 10px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
            z-index: 1001; grid-template-columns: repeat(3, 1fr); gap: 8px;
        }
        .dot { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 1px solid #eee; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="poema-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.2); display:none; justify-content:center; align-items:center; z-index:2000; backdrop-filter:blur(2px);">
    <div style="background:#fffdf5; padding:30px; border-radius:15px; width:80%; max-width:300px; text-align:center;">
        <div id="texto-poema" style="font-family:'Dancing Script'; font-size:1.5rem; margin-bottom:15px;"></div>
        <button class="btn-tema" style="font-size:0.8em;" onclick="togglePoema(false)">Entendido</button>
    </div>
</div>

<button id="papiro-btn" class="icon-btn" onclick="togglePoema(true)">üìú</button>
<button id="config-btn" class="icon-btn" onclick="toggleConfig()">‚öôÔ∏è</button>
<button id="add-btn-toggle" class="icon-btn" onclick="toggleAddForm()">+</button>

<div class="color-picker" id="picker">
    <div class="dot" style="background:#ff4d8d" onclick="changeTheme('#ff4d8d', '#fce4ec')"></div>
    <div class="dot" style="background:#3498db" onclick="changeTheme('#3498db', '#ebf5fb')"></div>
    <div class="dot" style="background:#2ecc71" onclick="changeTheme('#2ecc71', '#eafaf1')"></div>
    <div class="dot" style="background:#34495e" onclick="changeTheme('#34495e', '#f4f7f6')"></div>
    <div class="dot" style="background:#e67e22" onclick="changeTheme('#e67e22', '#fdf2e9')"></div>
    <div class="dot" style="background:#222" onclick="changeTheme('#222', '#f0f0f0')"></div>
</div>

<div class="container">
    <div id="login-screen">
        <h2 style="font-weight: 300;">Playlist Privada</h2>
        <input type="text" id="room-name" class="input-formal" placeholder="Nombre de la Sala">
        <input type="password" id="room-pass" class="input-formal" placeholder="Contrase√±a">
        <button class="btn-tema" onclick="accessRoom()">Entrar</button>
    </div>

    <div id="main-content" style="display:none;">
        <h1 id="display-room-name" class="room-title">SALA</h1>
        
        <div class="legend">
            <div class="legend-item"><div class="dot-l" style="background:#fdd835"></div> Pienso en ti</div>
            <div class="legend-item"><div class="dot-l" style="background:#66bb6a"></div> Me gusta</div>
            <div class="legend-item"><div class="dot-l" style="background:#42a5f5"></div> Me deprime</div>
            <div class="legend-item"><div class="dot-l" style="background:#ff5252"></div> Favorita</div>
        </div>

        <div id="total-count">0 CANCIONES</div>

        <div class="search-container">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="search-input" class="input-search" placeholder="Buscar canci√≥n..." oninput="render()">
            </div>
        </div>
        
        <div id="add-form">
            <input type="text" id="song-name" class="input-formal" placeholder="Nombre canci√≥n">
            <input type="text" id="song-url" class="input-formal" placeholder="URL YouTube">
            <select id="song-mood" class="input-formal">
                <option value="pienso">Pienso en ti üí≠</option>
                <option value="gusta">Me gusta üëç</option>
                <option value="deprime">Me deprime üíô</option>
                <option value="favorita">Mi Favorita ‚ù§Ô∏è</option>
            </select>
            <button class="btn-tema" style="font-size:0.8em;" onclick="saveSong()">Guardar</button>
        </div>

        <div id="playlist"></div>
        <div style="height: 60px;"></div>
        <span style="font-size: 0.6em; cursor: pointer; opacity: 0.3;" onclick="location.reload()">CERRAR SESI√ìN</span>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCMP_tpzNCNhakeG3wMd_P1YTJ-McmLL5k",
        authDomain: "nuestra-playlist-415c8.firebaseapp.com",
        databaseURL: "https://nuestra-playlist-415c8-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "nuestra-playlist-415c8",
        storageBucket: "nuestra-playlist-415c8.firebasestorage.app",
        messagingSenderId: "446803210132",
        appId: "1:446803210132:web:1347277b5bb8d3ec5f2981"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentRoom = "";
    let allSongs = [];

    function togglePoema(show) { document.getElementById('poema-overlay').style.display = show ? 'flex' : 'none'; }
    function toggleConfig() { const p = document.getElementById('picker'); p.style.display = p.style.display === 'grid' ? 'none' : 'grid'; }
    function toggleAddForm() {
        const f = document.getElementById('add-form');
        const b = document.getElementById('add-btn-toggle');
        f.style.display = f.style.display === 'block' ? 'none' : 'block';
        b.innerText = f.style.display === 'block' ? '‚úï' : '+';
    }

    function changeTheme(p, bg) { db.ref('salas/' + currentRoom).update({ theme: p, bg: bg }); document.getElementById('picker').style.display = 'none'; }
    function applyTheme(p, bg) { document.documentElement.style.setProperty('--tema', p); document.documentElement.style.setProperty('--fondo', bg); }

    function accessRoom() {
        const name = document.getElementById('room-name').value.trim().toLowerCase();
        const pass = document.getElementById('room-pass').value.trim();
        if(!name || !pass) return;

        db.ref('salas/' + name).once('value', (s) => {
            const d = s.val();
            if(d && d.password === pass) startSession(name);
            else if(!d) {
                if(confirm("¬øCrear esta sala?")) {
                    db.ref('salas/' + name).set({ password: pass, theme: '#34495e', bg: '#f4f7f6' });
                    startSession(name);
                }
            } else alert("Clave incorrecta");
        });
    }

    function startSession(name) {
        currentRoom = name;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.getElementById('display-room-name').innerText = name.toUpperCase();
        document.querySelectorAll('.icon-btn').forEach(btn => btn.style.display = 'flex');
        
        db.ref('salas/' + currentRoom).on('value', snap => {
            const d = snap.val();
            if(d && d.theme) applyTheme(d.theme, d.bg);
        });

        document.getElementById('texto-poema').innerText = "Tu m√∫sica, tu espacio.";
        db.ref('canciones/' + currentRoom).on('value', (snap) => {
            const d = snap.val();
            allSongs = d ? Object.keys(d).map(k => ({ id: k, ...d[k] })) : [];
            render();
        });
    }

    function saveSong() {
        const n = document.getElementById('song-name').value.trim();
        const u = document.getElementById('song-url').value.trim();
        const m = document.getElementById('song-mood').value;
        if (!n || !u) return;
        const idV = u.includes('v=') ? u.split('v=')[1].substring(0,11) : u.split('/').pop();
        db.ref('canciones/' + currentRoom).push({ name: n, url: u, mood: m, img: `https://img.youtube.com/vi/${idV}/mqdefault.jpg` });
        document.getElementById('song-name').value = ''; document.getElementById('song-url').value = '';
        toggleAddForm();
    }

    function render() {
        const list = document.getElementById('playlist');
        const count = document.getElementById('total-count');
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        
        list.innerHTML = '';
        const filteredSongs = allSongs.filter(s => s.name.toLowerCase().includes(searchTerm));
        filteredSongs.sort((a, b) => a.name.localeCompare(b.name, 'es', { sensitivity: 'base' }));
        
        count.innerText = allSongs.length + (allSongs.length === 1 ? " CANCI√ìN" : " CANCIONES");

        let currentLetter = "";
        filteredSongs.forEach(s => {
            let firstChar = s.name.charAt(0).toUpperCase();
            let displayLetter = /^[A-Z]$/.test(firstChar) ? firstChar : "#";
            
            if (displayLetter !== currentLetter) {
                currentLetter = displayLetter;
                const div = document.createElement('div');
                div.className = 'letter-divider';
                div.innerText = currentLetter;
                list.appendChild(div);
            }
            
            const card = document.createElement('div');
            card.className = `song-card ${s.mood}`;
            card.innerHTML = `<img src="${s.img}"><div class="song-info"><a href="${s.url}" target="_blank" style="text-decoration:none; color:inherit;"><b>${s.name}</b></a></div><button style="background:none; border:none; color:#ddd; cursor:pointer;" onclick="eliminar('${s.id}')">‚úï</button>`;
            list.appendChild(card);
        });
    }

    function eliminar(id) { if(confirm("¬øEliminar?")) db.ref('canciones/' + currentRoom + '/' + id).remove(); }
</script>
</body>
</html>
