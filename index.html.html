<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="https://fav.farm/üéµ" />
    <title>Playlist Privada</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Dancing+Script:wght@600&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <style>
        :root { 
            --tema: #34495e; --fondo: #f4f7f6; --card-bg: #ffffff; --texto: #2c3e50;
        }

        body { 
            font-family: 'Poppins', sans-serif; background: var(--fondo); 
            background-image: radial-gradient(at 0% 0%, rgba(52, 152, 219, 0.05) 0px, transparent 50%),
                              radial-gradient(at 100% 100%, rgba(46, 204, 113, 0.05) 0px, transparent 50%);
            display: flex; justify-content: center; align-items: flex-start; padding: 40px 15px; margin: 0; 
            min-height: 100vh; color: var(--texto);
        }
        
        .container { 
            background: rgba(255, 255, 255, 0.95);
            width: 100%; max-width: 900px; padding: 35px; 
            border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); text-align: center; 
            position: relative;
            contain: layout;
        }

        #login-screen { max-width: 320px; margin: 0 auto; padding: 20px 0; }
        #login-screen h2 { font-weight: 600; font-size: 1.5rem; margin-bottom: 25px; color: var(--tema); }
        .login-icon { font-size: 3rem; margin-bottom: 10px; display: block; }

        .room-title { font-family: 'Dancing Script', cursive; font-size: 2.2rem; color: var(--tema); margin: 0; cursor: pointer; }
        #total-count { font-size: 0.7em; letter-spacing: 2px; opacity: 0.5; font-weight: 700; margin-bottom: 20px; text-transform: uppercase; }

        #play-all-btn {
            display: inline-block; background: var(--tema); color: white; padding: 12px 20px;
            border-radius: 12px; text-decoration: none; font-size: 0.8em; font-weight: 600;
            margin-bottom: 25px; transition: transform 0.2s; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .search-container { display: flex; justify-content: center; margin-bottom: 25px; }
        .search-box { position: relative; width: 100%; max-width: 400px; }
        .input-search { 
            width: 100%; padding: 12px 15px 12px 40px; border-radius: 25px; 
            border: 1px solid #eee; background: #fff; font-family: 'Poppins'; 
            font-size: 0.85em; outline: none; box-sizing: border-box;
        }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); opacity: 0.3; }

        .legend { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-bottom: 20px; font-size: 0.6em; font-weight: 600; opacity: 0.7; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .dot-l { width: 10px; height: 10px; border-radius: 50%; }

        .input-formal { 
            width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 12px; 
            border: 1px solid #eee; box-sizing: border-box; font-family: 'Poppins'; font-size: 0.9em;
        }
        .btn-tema { 
            width: 100%; padding: 14px; border-radius: 12px; border: none; 
            background: var(--tema); color: white; font-weight: 600; cursor: pointer;
        }

        #add-form { display: none; margin-bottom: 30px; padding: 20px; background: #fafafa; border-radius: 15px; text-align: left; border: 1px solid #f0f0f0; }

        #playlist { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
            gap: 12px; 
            text-align: left; 
        }

        .letter-divider {
            grid-column: 1 / -1; display: flex; align-items: center; font-size: 0.7em; 
            color: var(--tema); opacity: 0.4; margin: 25px 0 10px; font-weight: 700;
        }
        .letter-divider::after { content: ""; flex: 1; height: 1px; background: var(--tema); margin-left: 15px; opacity: 0.1; }

        .song-card { 
            display: flex; flex-direction: column; padding: 15px; border-radius: 12px; 
            background: #fff; border: 1px solid #f0f0f0; transition: background 0.2s;
        }
        .song-main { display: flex; align-items: center; width: 100%; }
        .song-card img { width: 45px; height: 45px; border-radius: 8px; margin-right: 15px; object-fit: cover; background: #f0f0f0; }
        .song-info { flex: 1; overflow: hidden; }
        .song-info b { font-size: 0.85em; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* ESTILOS NUEVOS PARA LOS BOTONES DE ACCI√ìN */
        .actions-wrapper { display: flex; align-items: center; }
        .action-btns { display: flex; opacity: 0; transition: opacity 0.3s; gap: 12px; margin-left: 10px; }
        .song-card:hover .action-btns { opacity: 1; } /* Aparece en PC al pasar el rat√≥n */
        .action-btn { background: none; border: none; cursor: pointer; padding: 0; font-size: 14px; transition: transform 0.2s; }
        .action-btn:hover { transform: scale(1.2); }
        .mobile-options { display: none; background: none; border: none; color: #ccc; cursor: pointer; font-size: 1.4rem; padding: 0 5px; margin-left: 10px; }

        .comment-display { 
            font-size: 0.7em; margin-top: 8px; padding-top: 8px; border-top: 1px solid #f9f9f9; 
            color: #888; font-style: italic; cursor: pointer; transition: color 0.2s;
        }
        .comment-display:hover { color: var(--tema); }

        .pienso { border-left: 5px solid #fdd835; }
        .gusta { border-left: 5px solid #66bb6a; }
        .deprime { border-left: 5px solid #42a5f5; }
        .favorita { border-left: 5px solid #ff5252; }

        .icon-btn { 
            position: fixed; bottom: 25px; cursor: pointer; background: white; 
            width: 50px; height: 50px; border-radius: 50%; display: flex; 
            align-items: center; justify-content: center; box-shadow: 0 5px 20px rgba(0,0,0,0.1); 
            z-index: 1000; border: none; font-size: 1.2rem;
        }
        #add-btn-toggle { right: 25px; background: var(--tema); color: white; display: none; }
        #config-btn { right: 85px; display: none; color: #888; }

        .color-picker {
            display: none; position: fixed; bottom: 85px; right: 25px; 
            background: white; padding: 12px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            z-index: 1001; grid-template-columns: repeat(3, 1fr); gap: 10px;
        }
        .dot { width: 25px; height: 25px; border-radius: 50%; cursor: pointer; border: 1px solid #eee; }

        /* ADAPTACI√ìN PARA M√ìVILES */
        @media (max-width: 600px) {
            #playlist { grid-template-columns: 1fr; }
            .action-btns { display: none; opacity: 1; } /* Ocultos por defecto, pero con opacidad 1 para cuando se muestren */
            .mobile-options { display: block; } /* Mostrar bot√≥n de 3 puntos */
            .song-card.active-actions .action-btns { display: flex; } /* Mostrar botones al activar */
            .song-card.active-actions .mobile-options { display: none; } /* Ocultar 3 puntos al activar */
        }
    </style>
</head>
<body>

<button id="config-btn" class="icon-btn" onclick="toggleConfig()">‚öôÔ∏è</button>
<button id="add-btn-toggle" class="icon-btn" onclick="toggleAddForm()">+</button>

<div class="color-picker" id="picker">
    <div class="dot" style="background:#ff4d8d" onclick="changeTheme('#ff4d8d', '#fce4ec')"></div>
    <div class="dot" style="background:#3498db" onclick="changeTheme('#3498db', '#ebf5fb')"></div>
    <div class="dot" style="background:#2ecc71" onclick="changeTheme('#2ecc71', '#eafaf1')"></div>
    <div class="dot" style="background:#34495e" onclick="changeTheme('#34495e', '#f4f7f6')"></div>
    <div class="dot" style="background:#e67e22" onclick="changeTheme('#e67e22', '#fdf2e9')"></div>
    <div class="dot" style="background:#222" onclick="changeTheme('#222', '#f0f0f0')"></div>
</div>

<div class="container">
    <div id="login-screen">
        <span class="login-icon">üéß</span>
        <h2>Playlist Privada</h2>
        <input type="text" id="room-name" class="input-formal" placeholder="Nombre de la Sala">
        <input type="password" id="room-pass" class="input-formal" placeholder="Contrase√±a">
        <button class="btn-tema" onclick="accessRoom()">Entrar a la Sala</button>
    </div>

    <div id="main-content" style="display:none;">
        <h1 id="display-room-name" class="room-title" onclick="editRoomName()">SALA</h1>
        
        <div class="legend">
            <div class="legend-item"><div class="dot-l" style="background:#fdd835"></div> Pienso en ti</div>
            <div class="legend-item"><div class="dot-l" style="background:#66bb6a"></div> Me gusta</div>
            <div class="legend-item"><div class="dot-l" style="background:#42a5f5"></div> Me deprime</div>
            <div class="legend-item"><div class="dot-l" style="background:#ff5252"></div> Favorita</div>
        </div>

        <div id="total-count">0 CANCIONES</div>

        <a id="play-all-btn" href="#" target="_blank" style="display:none;">‚ñ∂Ô∏è REPRODUCIR TODA LA SALA (RANDOM)</a>

        <div class="search-container">
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="search-input" class="input-search" placeholder="Buscar artista o canci√≥n..." oninput="render()">
            </div>
        </div>
        
        <div id="add-form">
            <label id="form-title" style="font-size:0.7em; font-weight:700; color:var(--tema); margin-left:5px;">NUEVA CANCI√ìN</label>
            <input type="text" id="song-name" class="input-formal" placeholder="Nombre (Ej: Artista - Canci√≥n)">
            <input type="text" id="song-url" class="input-formal" placeholder="Link de YouTube">
            <select id="song-mood" class="input-formal">
                <option value="pienso">Pienso en ti üí≠</option>
                <option value="gusta">Me gusta üëç</option>
                <option value="deprime">Me deprime üíô</option>
                <option value="favorita">Mi Favorita ‚ù§Ô∏è</option>
            </select>
            <button id="save-btn" class="btn-tema" style="font-size:0.8em;" onclick="saveSong()">Guardar Canci√≥n</button>
        </div>

        <div id="playlist"></div>
        <div style="height: 60px;"></div>
        <span style="font-size: 0.6em; cursor: pointer; opacity: 0.3; letter-spacing: 1px;" onclick="location.reload()">CERRAR SESI√ìN</span>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCMP_tpzNCNhakeG3wMd_P1YTJ-McmLL5k",
        authDomain: "nuestra-playlist-415c8.firebaseapp.com",
        databaseURL: "https://nuestra-playlist-415c8-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "nuestra-playlist-415c8",
        storageBucket: "nuestra-playlist-415c8.firebasestorage.app",
        messagingSenderId: "446803210132",
        appId: "1:446803210132:web:1347277b5bb8d3ec5f2981"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentRoom = "";
    let allSongs = [];
    let editingSongId = null;

    function toggleConfig() { const p = document.getElementById('picker'); p.style.display = p.style.display === 'grid' ? 'none' : 'grid'; }
    
    function toggleAddForm() {
        const f = document.getElementById('add-form');
        const b = document.getElementById('add-btn-toggle');
        
        if (f.style.display === 'block') {
            f.style.display = 'none';
            b.innerText = '+';
            editingSongId = null;
            document.getElementById('song-name').value = ''; 
            document.getElementById('song-url').value = '';
            document.getElementById('form-title').innerText = 'NUEVA CANCI√ìN';
        } else {
            f.style.display = 'block';
            b.innerText = '‚úï';
        }
    }

    function changeTheme(p, bg) { db.ref('salas/' + currentRoom).update({ theme: p, bg: bg }); document.getElementById('picker').style.display = 'none'; }
    function applyTheme(p, bg) { document.documentElement.style.setProperty('--tema', p); document.documentElement.style.setProperty('--fondo', bg); }

    function editRoomName() {
        const nuevoNombre = prompt("Nuevo nombre para la sala:", document.getElementById('display-room-name').innerText);
        if(nuevoNombre) db.ref('salas/' + currentRoom).update({ customTitle: nuevoNombre });
    }

    function accessRoom() {
        const name = document.getElementById('room-name').value.trim().toLowerCase();
        const pass = document.getElementById('room-pass').value.trim();
        if(!name || !pass) return;

        db.ref('salas/' + name).once('value', (s) => {
            const d = s.val();
            if(d && d.password === pass) startSession(name);
            else if(!d) {
                if(confirm("¬øCrear esta nueva sala?")) {
                    db.ref('salas/' + name).set({ password: pass, theme: '#34495e', bg: '#f4f7f6', customTitle: name });
                    startSession(name);
                }
            } else alert("Contrase√±a incorrecta");
        });
    }

    function startSession(name) {
        currentRoom = name;
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('main-content').style.display = 'block';
        document.querySelectorAll('.icon-btn').forEach(btn => btn.style.display = 'flex');
        
        db.ref('salas/' + currentRoom).on('value', snap => {
            const d = snap.val();
            if(d) {
                if(d.theme) applyTheme(d.theme, d.bg);
                document.getElementById('display-room-name').innerText = (d.customTitle || currentRoom).toUpperCase();
            }
        });

        db.ref('canciones/' + currentRoom).on('value', (snap) => {
            const d = snap.val();
            allSongs = d ? Object.keys(d).map(k => ({ id: k, ...d[k] })) : [];
            render();
        });
    }

    function saveSong() {
        const n = document.getElementById('song-name').value.trim();
        const u = document.getElementById('song-url').value.trim();
        const m = document.getElementById('song-mood').value;
        if (!n || !u) return;
        const idV = u.includes('v=') ? u.split('v=')[1].substring(0,11) : u.split('/').pop().split('?')[0];
        const imgUrl = `https://img.youtube.com/vi/${idV}/mqdefault.jpg`;

        if (editingSongId) {
            db.ref('canciones/' + currentRoom + '/' + editingSongId).update({ name: n, url: u, mood: m, img: imgUrl });
            editingSongId = null;
            document.getElementById('form-title').innerText = 'NUEVA CANCI√ìN';
        } else {
            db.ref('canciones/' + currentRoom).push({ name: n, url: u, mood: m, img: imgUrl, comment: "" });
        }

        document.getElementById('song-name').value = ''; 
        document.getElementById('song-url').value = '';
        document.getElementById('add-form').style.display = 'none';
        document.getElementById('add-btn-toggle').innerText = '+';
    }

    function editSongInfo(id) {
        const song = allSongs.find(s => s.id === id);
        if(!song) return;
        
        document.getElementById('song-name').value = song.name;
        document.getElementById('song-url').value = song.url;
        document.getElementById('song-mood').value = song.mood;
        
        editingSongId = id;
        document.getElementById('form-title').innerText = 'EDITAR CANCI√ìN';
        
        document.getElementById('add-form').style.display = 'block';
        document.getElementById('add-btn-toggle').innerText = '‚úï';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function addComment(id, currentComment) {
        const msg = prompt("Escribe un comentario sobre esta canci√≥n:", currentComment || "");
        if (msg !== null) db.ref('canciones/' + currentRoom + '/' + id).update({ comment: msg });
    }

    function toggleActions(btn) {
        // Cierra los men√∫s de otras canciones abiertas
        document.querySelectorAll('.song-card.active-actions').forEach(card => {
            if (card !== btn.closest('.song-card')) card.classList.remove('active-actions');
        });
        // Abre/Cierra el men√∫ de la canci√≥n seleccionada
        btn.closest('.song-card').classList.toggle('active-actions');
    }

    function render() {
        const list = document.getElementById('playlist');
        const count = document.getElementById('total-count');
        const playAllBtn = document.getElementById('play-all-btn');
        const searchTerm = document.getElementById('search-input').value.toLowerCase();
        const fragment = document.createDocumentFragment();
        
        const filteredSongs = allSongs.filter(s => s.name.toLowerCase().includes(searchTerm));
        filteredSongs.sort((a, b) => a.name.localeCompare(b.name, 'es', { sensitivity: 'base' }));
        
        count.innerText = allSongs.length + (allSongs.length === 1 ? " CANCI√ìN" : " CANCIONES");

        if (allSongs.length > 0) {
            let randomSongs = [...allSongs].sort(() => 0.5 - Math.random()).slice(0, 50);
            const ids = randomSongs.map(s => s.url.includes('v=') ? s.url.split('v=')[1].substring(0,11) : s.url.split('/').pop().split('?')[0]);
            playAllBtn.href = `https://www.youtube.com/watch_videos?video_ids=${ids.join(',')}`;
            playAllBtn.style.display = 'inline-block';
        }

        let currentLetter = "";
        filteredSongs.forEach(s => {
            let firstChar = s.name.charAt(0).toUpperCase();
            let displayLetter = /^[A-Z]$/.test(firstChar) ? firstChar : "#";
            
            if (displayLetter !== currentLetter) {
                currentLetter = displayLetter;
                const div = document.createElement('div');
                div.className = 'letter-divider';
                div.innerText = currentLetter;
                fragment.appendChild(div);
            }
            
            const card = document.createElement('div');
            card.className = `song-card ${s.mood}`;
            card.innerHTML = `
                <div class="song-main">
                    <img src="${s.img}" loading="lazy" width="45" height="45">
                    <div class="song-info">
                        <a href="${s.url}" target="_blank" style="text-decoration:none; color:inherit;">
                            <b>${s.name}</b>
                        </a>
                    </div>
                    
                    <div class="actions-wrapper">
                        <button class="mobile-options" onclick="toggleActions(this)">‚ãÆ</button>
                        <div class="action-btns">
                            <button class="action-btn" style="color:#999;" onclick="editSongInfo('${s.id}')" title="Editar">‚úèÔ∏è</button>
                            <button class="action-btn" style="color:#bbb;" onclick="eliminar('${s.id}')" title="Eliminar">‚úï</button>
                        </div>
                    </div>

                </div>
                <div class="comment-display" onclick="addComment('${s.id}', '${s.comment || ""}')">
                    ${s.comment ? 'üí¨ ' + s.comment : '+ A√±adir comentario...'}
                </div>
            `;
            fragment.appendChild(card);
        });

        list.innerHTML = '';
        list.appendChild(fragment);
    }

    function eliminar(id) { if(confirm("¬øEliminar canci√≥n?")) db.ref('canciones/' + currentRoom + '/' + id).remove(); }
</script>
</body>
</html>
